#Persistent
#SingleInstance FORCE
#Include SAMP.ahk
CommandProcessor := new CommandProcessor()
CommandProcessor.SetStatusProcessor(true)
CommandProcessor.RegisterCommand("/an", "mycomand")
~LButton::
if (A_PriorHotkey <> "~LButton" or A_TimeSincePriorHotkey > 500)
{
	KeyWait, LButton
	return
}
if (menu==1){
	menu:=0
	SendChat("/sms " telefon " " GetDialogLine(getDialogLineNumber()))
	return
}
~Enter::
if (menu==1){
	menu:=0
	SendChat("/sms " telefon " " GetDialogLine(getDialogLineNumber()))
	return
}
if(CommandProcessor.StatusProcessor) {
	if(IsChatActive()) {
		if(isDialogOpen())
			return
		
		blockChatInput()
		while(IsChatActive())
			continue
		
		unBlockChatInput()
		
		TextChat := GetChatText()
		
		if(SubStr(TextChat, 1, 1) = "/") { ; Определено что введена команда
			InputCMD := StrSplit(TextChat, A_Space)
			InputCMD := InputCMD[1]
			CommandProcessor.TempCmd := InputCMD
			CommandProcessor.TempText := TextChat
			
			if(CommandProcessor.CommandArray.HasKey(InputCMD)) { ; Если команда определена в скрипте
				ClearTextDialog()
				SetTimer, % CommandProcessor.CommandArray[InputCMD], -1
			} else { ; Если команда не определена
				SendChat(TextChat)
				ClearTextDialog()
			}
		} else { ; Определено что вводиться обычный текст
			if(TextChat != "") {
				CommandProcessor.TempText := TextChat
				SendChat(TextChat)
				ClearTextDialog()
			}
		}
	}
}

return

mycomand:
{
	chatInput:=CommandProcessor.TempText
	if (RegExMatch(chatInput,"^/an"))
	{
		if (RegExMatch(chatInput,"/an ([0-9]{1,8}) ([А-я]+)", out))
		{
			telefon:="" out1 ""
			anagrama:="" out2 ""
			site:=get("http://live.mephist.ru/anagram_find.php?nc=2&params=" anagrama)
			Error:="<div class=Err>Для сочетания &laquo;<strong>" anagrama "</strong>&raquo; ни одной анаграммы не найдено</div>"
			if (site=Error)
			{
				addChatMessageEx("00FF00", "Для сочетания {f44336}'" anagrama "'{00FF00} ни одной анаграммы не найдено")
			}
			else
			{
				v:=1
				loop, Parse, site, `n,
				{
					if (RegExMatch(A_LoopField, "\>([А-я]+)</a>", out))
					{
						anag%v%:="" out1 ""
						v++
					}
					else if (RegExMatch(A_LoopField, "\>([А-я]+)</a>", out))
					{
						anag%v%:="" out1 ""
						v++
					}
					else if (RegExMatch(A_LoopField, "\>([А-я]+)</a>", out))
					{
						anag%v%:="" out1 ""
						v++
					}
					else if (RegExMatch(A_LoopField, "\>([А-я]+)</a>", out))
					{
						anag%v%:="" out1 ""
						v++
					}
					else if (RegExMatch(A_LoopField, "\>([А-я]+)</a>", out))
					{
						anag%v%:="" out1 ""
						v++
					}
				}
				Sleep, 50
				anagr:=[,"" anag1 ""
				,"" anag2 ""
				,"" anag3 ""
				,"" anag4 ""
				,"" anag5 ""]
				menu:=1
				showDialog(2, "Выберете 1 из вариантов ответов", gettext(anagr), "Закрыть")
			}
		}
		else
		{
			addChatMessageEx("00FF00", "Ай не хуя, используй {f44336}/an {00FF00}[ {f44336}номер радиостудии{00FF00} ] [ {f44336}сама анаграмма. пример: укарч {00FF00}]")
		}
	}
}
return
